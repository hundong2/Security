# 튜플 해시(Tuple Hash)란?
여러 개의 값(튜플)을 “구조적으로” 해싱해, 단순 이어붙이기에서 생기는 모호성과 충돌 위험을 없애는 방법입니다. NIST SP 800-185는 이를 표준화한 TupleHash를 정의합니다.

## 예시 파일
[NIST SP 800-185 (cSHAKE, KMAC, TupleHash, ParallelHash)](https://csrc.nist.gov/publications/detail/sp/800-185/final)

## 답변
핵심 문제: 단순 연결(concatenation)은 경계가 모호합니다. 예를 들어:
- "Alice" "Bob" "100" "15" → 연결하면 "AliceBob10015"
- "Alice" "Bob" "1001" "5" → 연결해도 "AliceBob10015"
따라서 sha3-256로 해시하면 동일 결과가 나올 수 있습니다.

1) 문제 재현(모호한 연결)
````sh
# 둘 다 동일 문자열로 취급되어 같은 해시가 나옴
echo -n "Alice""Bob""100""15"  | openssl dgst -sha3-256
echo -n "Alice""Bob""1001""5" | openssl dgst -sha3-256
````

2) 간단 해결: 길이-접두 인코딩(“netstring”/길이 프리픽스) 후 해시
- 각 항목을 [len]:[data], 형식으로 직렬화하면 경계가 명확해집니다.
````sh
# netstring 예: "5:Alice,3:Bob,3:100,2:15," vs "5:Alice,3:Bob,4:1001,1:5,"
echo -n '5:Alice,3:Bob,3:100,2:15,'  | openssl dgst -sha3-256
echo -n '5:Alice,3:Bob,4:1001,1:5,'  | openssl dgst -sha3-256  # 서로 다른 해시
````

3) 실무 안전 패턴(권장): 길이 프리픽스 + 도메인 분리 + 고정 인코딩
- UTF-8로 바이트화 → 4바이트 길이(빅엔디언) 접두 → 도메인 태그 추가.
````python
import hashlib

def encode_tuple(parts):
    out = b"TUPLEv1"  # 도메인 분리 태그
    for p in parts:
        b = p.encode("utf-8") if isinstance(p, str) else bytes(p)
        out += len(b).to_bytes(4, "big") + b
    return out

def tuple_hash_sha3_256(parts):
    return hashlib.sha3_256(encode_tuple(parts)).hexdigest()

print("A:", tuple_hash_sha3_256(["Alice","Bob","100","15"]))
print("B:", tuple_hash_sha3_256(["Alice","Bob","1001","5"]))  # A와 반드시 달라짐
````

4) 표준 TupleHash(NIST SP 800-185)
- cSHAKE 위에 “left_encode/encode_string/bytepad” 등 표준 인코딩을 얹어 경계를 보장합니다.
- 이름: TupleHash128/256. 출력 길이는 XOF라 원하는 길이로 뽑을 수 있습니다.
- OpenSSL CLI에는 직접 노출되지 않으며, 라이브러리(예: Python PyCryptodome의 cSHAKE/ TupleHash 구현)를 사용합니다.
- 포인트:
  - 각 요소를 길이로 인코딩(encode_string)해 모호성 제거
  - 함수명(FunctionName)/커스텀 문자열로 도메인 분리
  - SHA-3 스펀지(cSHAKE) 기반

요약 가이드:
- 단순 연결 금지.
- 길이-접두(또는 netstring/TLV/ASN.1 DER/CBOR 등 표준 직렬화)로 경계 보장.
- 가능하면 표준 TupleHash(800-185)나 cSHAKE 기반 구현 사용.
- 항상 UTF-8 등 고정 인코딩, 도메인 분리를 적용.

### 추가 자료
- [NIST SP 800-185 표준 전문(PDF)](https://csrc.nist.gov/publications/detail/sp/800-185/final)
- [Keccak 팀: cSHAKE/KMAC/TupleHash 설명](https://keccak.team/keccak_specs_summary.html)